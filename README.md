# 网球场自动预订脚本

一个 Python 自动化脚本，用于 Scarborough Winter Tennis Club (SWTC) 网球场预订系统。支持即时预订和定时预订两种模式。

## 功能特性

- **双模式运行**：即时预订 或 定时预订（每天早上 8:15:01 自动执行）
- **智能时间段选择**：自动查找 2pm-9pm 范围内的可用时间段
- **连续时段匹配**：优先预订连续2小时的时间段
- **场地筛选**：支持指定场地号（6-10号场）
- **自动重试机制**：未找到时间段时自动刷新重试
- **预订统计**：显示所有成功预订的详细信息和场地分组
- **保持登录状态**：连接已打开的 Edge 浏览器，无需重复登录

## 安装

```bash
pip install -r requirements.txt
```

## 使用方法

### 方法 1：使用已打开的浏览器（推荐）

这样可以保持你的登录状态，不需要每次都登录。

#### 步骤 1：启动 Edge（远程调试模式）

**macOS:**
```bash
chmod +x start_edge.sh
./start_edge.sh
```

或者手动运行：
```bash
"/Applications/Microsoft Edge.app/Contents/MacOS/Microsoft Edge" --remote-debugging-port=9222
```

**Windows:**
```cmd
msedge.exe --remote-debugging-port=9222
```

**Linux:**
```bash
microsoft-edge --remote-debugging-port=9222
```

#### 步骤 2：登录并打开预订页面

1. 在启动的 Edge 浏览器中登录你的账户
2. 导航到预订页面
3. 选择好要预订的日期

#### 步骤 3：运行脚本

运行脚本：
```bash
python tennis_booking.py
```

脚本会提供两个选项：
- **选项 1**：立即运行预订
- **选项 2**：定时运行（每天早上 8:15:01 自动执行）

### 配置参数

在 `tennis_booking.py` 文件中可以配置：

```python
# 预订配置
NUM_SLOTS = 2           # 要预订的时间段数量
TIME_RANGE_START = 14   # 开始时间（14 = 2pm）
TIME_RANGE_END = 21     # 结束时间（21 = 9pm）
COURT_NUMBERS = [6, 7, 8, 9, 10]  # 场地号码

# 重试配置
MAX_RETRIES = 5         # 最大重试次数
RETRY_INTERVAL = 2      # 重试间隔（秒）

# 确认配置
CLICK_CONFIRM = True    # 是否自动点击确认按钮
```

## 工作原理

### 预订流程

1. **初始刷新**：脚本启动时自动刷新页面，确保数据最新
2. **查找时间段**：扫描页面上所有可用的时间段按钮（`button[data-value].available`）
3. **筛选匹配**：
   - 按时间范围过滤（2pm-9pm）
   - 按场地号码过滤（6-10号场）
   - 优先查找连续2小时的时间段
4. **点击预订**：
   - 点击选中的时间段按钮
   - 点击 Book 按钮（`a[onclick='book()']`）
   - 自动点击确认按钮（`a[onclick='bookSubmit()']`）
5. **统计输出**：显示所有成功预订的时间段和场地分组

### 时间段数据格式

网站使用 `data-value` 属性存储时间和场地信息：
```html
<button data-value="800|900|10" class="available" onclick="toggleCourt(this)">10</button>
```
格式：`开始时间|结束时间|场地号`（时间使用24小时制，如 800 = 8:00am，1400 = 2:00pm）

### 定时模式详情

选择定时模式后：
- 脚本会显示实时倒计时，等待到 8:15:01 AM
- 到达指定时间后自动执行预订流程
- 适合竞争激烈的预订场景，抢占先机

## 脚本文件说明

### 主要文件

- **`tennis_booking.py`**：主预订脚本（541行，优化简化版）
- **`start_edge.sh`**：启动 Edge 浏览器的辅助脚本（macOS）
- **`check_edge.sh`**：检查 Edge 远程调试状态的脚本
- **`requirements.txt`**：Python 依赖包列表
- **`test_buttons.py`**：按钮测试脚本（用于调试）

### 关键函数

- `setup_driver()`：连接到远程调试模式的 Edge 浏览器
- `click_refresh_button()`：点击刷新按钮更新页面数据
- `find_available_slots()`：查找所有可用时间段
- `find_consecutive_slots()`：查找连续时间段
- `select_slots()`：选择并点击时间段
- `click_book_button()`：点击 Book 按钮
- `handle_confirmation_dialog()`：处理确认对话框
- `wait_until_target_time()`：定时模式的倒计时功能
- `run_booking_flow()`：完整的预订流程执行

## 故障排查

### Edge 连接失败
```bash
./check_edge.sh  # 检查 Edge 状态
./start_edge.sh  # 重新启动 Edge
```

### 未找到时间段
- 确认已在浏览器中选择正确的日期
- 检查时间范围和场地号配置是否正确
- 脚本会自动刷新重试，最多重试 5 次

### 预订未成功
- 检查 `CLICK_CONFIRM` 是否设置为 `True`
- 确认浏览器中没有其他弹窗干扰
- 查看终端输出的详细错误信息

## 注意事项

- 必须先用远程调试模式启动 Edge 浏览器
- 需要手动在浏览器中登录并选择日期
- 定时模式下脚本会一直运行直到指定时间
- 每次预订后会显示详细的统计信息
- 使用 Ctrl+C 可以随时终止脚本

## 技术栈

- **Python 3.14**
- **Selenium WebDriver** - 浏览器自动化
- **Microsoft Edge** - 远程调试模式
- **网站**：https://members.swtc.ca/booking.html#

## 使用示例

### 示例输出

```
============================================================
网球场快速预订脚本
============================================================

请选择运行模式：
1. 立即开始预订
2. 定时预订（8:15:01 AM 自动运行）

请输入选项 (1 或 2): 2

请确保：
1. 已使用远程调试模式启动 Edge 浏览器
2. 已在浏览器中手动登录到预订网站
3. 当前页面是预订页面
4. 已选择好要预订的日期
============================================================
正在连接到已打开的 Edge 浏览器...
✅ 已连接到现有浏览器

当前页面: https://members.swtc.ca/booking.html#
页面标题: Court Booking

⏰ 等待到 8:15:01 执行预订...
当前时间: 08:14:58 | 倒计时: 00:00:03

🚀 时间到！开始执行预订...

🔄 刷新页面以获取最新时间段...
✅ 已点击刷新按钮

============================================================
🎾 尝试预订时间段 (尝试 1/5)
============================================================

🔍 正在查找可用时间段...
   时间范围: 14:00 - 21:00
   场地范围: 6, 7, 8, 9, 10

找到 12 个可用时间段

✅ 成功选择并点击了 2 个时间段:
   ✓ 2:00pm-3:00pm (球场 7)
   ✓ 3:00pm-4:00pm (球场 7)

✅ 已点击 Book 按钮
✅ 已点击确认按钮

============================================================
✅ 预订流程完成！
============================================================

📊 本次预订汇总：
总共预订了 2 个时间段

球场 7: 2 个时间段
  1. 2:00pm-3:00pm
  2. 3:00pm-4:00pm
```

## 更新日志

### v2.0 (最新版本)
- ✅ 添加双模式运行（即时/定时）
- ✅ 定时模式支持 8:15:01 AM 自动执行
- ✅ 添加自动刷新功能
- ✅ 添加预订统计和场地分组
- ✅ 优化代码，从 992 行精简到 541 行（减少 45%）
- ✅ 改进选择器，使用实际 HTML 结构
- ✅ 合并时间段和场地选择为单次操作
- ✅ 改进错误处理和用户反馈

### v1.0
- 基础预订功能
- 连接远程浏览器
- 时间段选择

## 许可证

MIT License

---

**祝预订顺利！🎾**

